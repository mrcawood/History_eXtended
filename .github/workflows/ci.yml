name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Start MinIO
        run: |
          docker run -d --name minio \
            -p 9000:9000 -p 9001:9001 \
            -e MINIO_ROOT_USER=minioadmin \
            -e MINIO_ROOT_PASSWORD=minioadmin \
            minio/minio:RELEASE.2025-09-07T16-13-09Z \
            server /data --console-address ":9001"

          # Wait for readiness from the runner (don't rely on container health-cmd needing curl inside the image)
          for i in {1..60}; do
            if curl -fsS http://127.0.0.1:9000/minio/health/live >/dev/null; then
              echo "MinIO is up"
              exit 0
            fi
            sleep 1
          done

          docker logs minio
          exit 1

      - name: Build
        run: go build -tags sqlite_fts5 -o /dev/null ./cmd/hx ./cmd/hxd ./cmd/hx-emit

      - name: Unit Tests
        run: go test -tags sqlite_fts5 -v ./...

      - name: Phase 2A Integration Tests
        run: |
          go test ./testdata/integration/... -race -v

      - name: Phase 2B S3 Integration Tests
        env:
          HX_REQUIRE_S3_ENDPOINT: "1"
          HX_S3_ENDPOINT: "http://127.0.0.1:9000"
          HX_S3_ACCESS_KEY: "minioadmin"
          HX_S3_SECRET_KEY: "minioadmin"
        run: |
          go test ./internal/sync/... -v -race \
            -run "TestTwoNodeConverge_MinIO|TestTombstonePropagation_MinIO|TestCorruptManifest_MinIO|TestEfficiency_ManifestReducesListCalls|TestRetryableStore_MinIOIntegration"

      - name: Security Validation Tests
        run: |
          go test ./internal/sync/... -v -race \
            -run "TestValidate|TestSecure|TestSanitize|TestResource|TestPathTraversalPrevention"

      - name: Test Coverage
        run: |
          go test -tags sqlite_fts5 -coverprofile=coverage.out ./...
          go tool cover -html=coverage.out -o coverage.html

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests

      - name: Validate (A1-A7 golden dataset)
        run: |
          make build
          chmod +x scripts/validate.sh
          ./scripts/validate.sh

      - name: Cleanup MinIO
        if: always()
        run: |
          docker stop minio || true
          docker rm minio || true

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m
