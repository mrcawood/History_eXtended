name: CI

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      minio:
        image: minio/minio:RELEASE.2024-08-26T05-32-52Z
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin
        ports:
          - 9000:9000
          - 9001:9001
        options: >-
          --health-cmd "curl -f http://localhost:9000/minio/health/live"
          --health-interval 30s
          --health-timeout 20s
          --health-retries 3

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Install AWS CLI
        run: |
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip awscliv2.zip
          sudo ./aws/install

      - name: Setup MinIO
        run: |
          # Wait for MinIO to be ready
          timeout 60 bash -c 'until curl -f http://localhost:9000/minio/health/live; do sleep 2; done'
          # Set up AWS CLI for MinIO
          aws configure set aws_access_key_id minioadmin
          aws configure set aws_secret_access_key minioadmin
          aws configure set default.region us-east-1
          # Create test bucket
          aws --endpoint-url http://localhost:9000 s3 mb s3://hx-test || true
          # Verify bucket exists
          aws --endpoint-url http://localhost:9000 s3 ls

      - name: Build
        run: go build -tags sqlite_fts5 -o /dev/null ./cmd/hx ./cmd/hxd ./cmd/hx-emit

      - name: Unit Tests
        run: go test -tags sqlite_fts5 -v ./...

      - name: Phase 2A Integration Tests
        run: |
          go test ./testdata/integration/... -race -v

      - name: Phase 2B S3 Integration Tests
        run: |
          HX_REQUIRE_S3_ENDPOINT=1 go test ./internal/sync/... -v -race \
            -run "TestTwoNodeConverge_MinIO|TestTombstonePropagation_MinIO|TestCorruptManifest_MinIO|TestEfficiency_ManifestReducesListCalls|TestRetryableStore_MinIOIntegration"

      - name: Security Validation Tests
        run: |
          go test ./internal/sync/... -v -race \
            -run "TestValidate|TestSecure|TestSanitize|TestResource|TestPathTraversalPrevention"

      - name: Test Coverage
        run: |
          go test -tags sqlite_fts5 -coverprofile=coverage.out ./...
          go tool cover -html=coverage.out -o coverage.html

      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.out
          flags: unittests

      - name: Validate (A1-A7 golden dataset)
        run: |
          make build
          chmod +x scripts/validate.sh
          ./scripts/validate.sh

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          args: --timeout=5m
